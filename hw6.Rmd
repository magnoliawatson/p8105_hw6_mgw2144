---
title: "hw6"
output: github_document
date: "2023-11-29"
---

```{r}
library(tidyverse)
library(p8105.datasets)
library(modelr)
library(mgcv)

set.seed(1)
```

# Problem 1 

# Problem 2

```{r message=FALSE}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2022-01-01",
    date_max = "2022-12-31") |>
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) |>
  select(name, id, everything())
```

```{r}
lm(tmax ~ tmin + prcp, data = weather_df)

boot_sample = function(df) {
  sample_frac(df, replace=TRUE)
}

boot_straps = 
  tibble(strap_number = 1:5000) %>% 
  mutate(
    strap_sample = map(strap_number, ~boot_sample(df = weather_df))
  )

boot_straps %>% 
  slice(1:3) %>% 
  mutate(strap_sample = map(strap_sample, arrange, tmax)) %>%  
  pull(strap_sample)
```

```{r}
bootstrap_results = 
  boot_straps %>% 
  mutate(
    models = map(strap_sample, ~lm(tmax ~ tmin + prcp, data = .)
  ), 
    results = map(models, broom::tidy),
    r_squared = map_dbl(models, ~broom::glance(.x)$r.squared),
    log_beta = map_dbl(models, ~ {
      coef <- coefficients(.x)
      if (coef[2] * coef[3] >= 0) log(coef[2] * coef[3]) else NA_real_
    })
  ) %>% 
  select(-strap_sample, -models) %>% 
  unnest(results)

```

## Plotting the distributions of estimates for r_squared and log_beta

```{r}
estimate_plot_rs = 
bootstrap_results %>% 
  ggplot(aes(x = r_squared)) + geom_density()

estimate_plot_rs
```

The distribution of the r sqaured estimates appears approximately normal but may have a slight left skew. This slight skew is likely due to random sampling variability. 

```{r}
estimate_plot_log = 
bootstrap_results %>% 
  ggplot(aes(x = log_beta)) + geom_density()

estimate_plot_log
```

The distribution of the log(beta_1*beta_2) estimates is strongly left skewed. This may be due to the fact that there were several negative beta estimates that could not be used in the log calculations, indicating that this may not be representative of the dataset the bootstrap was performed on. 

## Identifying 95% Confidence Intervals

```{r}
bootstrap_results %>%  
  summarize(
    ci_lower = quantile(r_squared, 0.025), 
    ci_upper = quantile(r_squared, 0.975))
```

We are 95% confident that the true r-squared value is between 0.889 and 0.941.

```{r}
bootstrap_results %>%  
  summarize(
    ci_lower = quantile(log_beta, 0.025, na.rm = TRUE), 
    ci_upper = quantile(log_beta, 0.975, na.rm = TRUE))
```

We are 95% confident that the true log(beta_1*beta_2) value is between -8.98 and -4.60. 

# Problem 3 

## Tidying the data
```{r}
birthweight_df = 
  read_csv("data/birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate(across(c(babysex, frace, malform, mrace), as_factor)) %>% 
  select(-pnumsga, -pnumlbw)

missing_val_check = 
  birthweight_df %>% 
  summarise_all(~sum(is.na(.)))
```

## Regression model
```{r}
fit = 
  lm(bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + malform + menarche + mheight + momage + mrace + parity + ppbmi + ppwt + smoken + wtgain, data = birthweight_df)

summary(fit)

fit_2 = 
  lm(bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + menarche + mheight + momage + mrace + parity + ppbmi + ppwt + smoken + wtgain, data = birthweight_df)

summary(fit_2)

fit_3 = 
  lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + menarche + mheight + momage + mrace + parity + ppbmi + ppwt + smoken + wtgain, data = birthweight_df)

summary(fit_3)

fit_4 = 
  lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + menarche + mheight + momage + mrace + parity + ppwt + smoken + wtgain, data = birthweight_df)

summary(fit_4)

fit_5 = 
  lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + menarche + mheight + mrace + parity + ppwt + smoken + wtgain, data = birthweight_df)

summary(fit_5)

fit_6 = 
  lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + parity + ppwt + smoken + wtgain, data = birthweight_df)

summary(fit_6)

fit_7 = 
  lm(bwt ~ babysex + bhead + blength + delwt + gaweeks + mheight + mrace + parity + ppwt + smoken + wtgain, data = birthweight_df)

summary(fit_7)

fit_7 %>%  
  broom::glance()
```

rmse values 
start with full model 
no need to look for interaction

Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process and show a plot of model residuals against fitted values â€“ use add_predictions and add_residuals in making this plot.